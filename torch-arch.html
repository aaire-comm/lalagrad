<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <style>
    body { font-family: sans-serif; }
    .node circle { fill: #1f77b4; stroke: #fff; stroke-width: 1.5px; }
    .node text { font-size: 12px; pointer-events: none; }
    .link { stroke: #999; stroke-opacity: 0.6; stroke-width: 1.5px; }
    .tooltip {
      position: absolute;
      text-align: left;
      width: 250px;
      padding: 10px;
      font: 12px sans-serif;
      background: rgba(0,0,0,0.7);
      color: #fff;
      border: 0px;
      border-radius: 8px;
      pointer-events: none;
    }
  </style>
</head>
<body>
<div id="tooltip" class="tooltip" style="opacity:0;"></div>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>

// ------------------------
// Nodes and edges
// ------------------------
const nodes = [
  {id: "Python Tensor", info: "High-level Python object; wraps C++ Tensor; stores dtype, device, shape, strides."},
  {id: "Storage", info: "Raw memory buffer; holds contiguous data; shared between tensors via views."},
  {id: "Autograd", info: "Tracks operations; builds computation graph; contains grad_fn, next_edges, saved_tensors."},
  {id: "Dispatcher", info: "Maps operation + dispatch key â†’ kernel; selects correct kernel based on device/dtype/layout."},
  {id: "Dispatch Key", info: "Tag indicating device, dtype, layout, autograd wrapper, etc. Used to route ops."},
  {id: "ATen Kernel", info: "C++ implementation of operation; device-specific; dtype-specific; performs actual computation."},
  {id: "CUDA/CPU Backend", info: "Hardware-specific implementation; calls cuBLAS/cuDNN or CPU loops/vectorized code."},
  {id: "Operator Schema", info: "Defines op signature: inputs, outputs, default args; e.g., aten::add.Tensor(Tensor a, Tensor b)."}
];

const links = [
  {source: "Python Tensor", target: "Storage"},
  {source: "Python Tensor", target: "Autograd"},
  {source: "Python Tensor", target: "Dispatcher"},
  {source: "Dispatcher", target: "Dispatch Key"},
  {source: "Dispatcher", target: "ATen Kernel"},
  {source: "Dispatch Key", target: "ATen Kernel"},
  {source: "ATen Kernel", target: "CUDA/CPU Backend"},
  {source: "Dispatcher", target: "Operator Schema"}
];

// ------------------------
// D3 Force-directed graph
// ------------------------
const width = 1000, height = 600;

const svg = d3.select("body").append("svg")
  .attr("width", width)
  .attr("height", height);

const simulation = d3.forceSimulation(nodes)
  .force("link", d3.forceLink(links).id(d => d.id).distance(180))
  .force("charge", d3.forceManyBody().strength(-600))
  .force("center", d3.forceCenter(width / 2, height / 2));

const link = svg.append("g")
    .attr("stroke", "#999")
    .attr("stroke-opacity", 0.6)
  .selectAll("line")
  .data(links)
  .join("line")
    .attr("stroke-width", 2);

const node = svg.append("g")
    .attr("stroke", "#fff")
    .attr("stroke-width", 1.5)
  .selectAll("g")
  .data(nodes)
  .join("g")
  .call(d3.drag()
      .on("start", dragstarted)
      .on("drag", dragged)
      .on("end", dragended));

node.append("circle")
    .attr("r", 25)
    .on("mouseover", showTooltip)
    .on("mouseout", hideTooltip);

node.append("text")
    .attr("text-anchor", "middle")
    .attr("dy", 4)
    .text(d => d.id);

const tooltip = d3.select("#tooltip");

simulation.on("tick", () => {
  link
      .attr("x1", d => d.source.x)
      .attr("y1", d => d.source.y)
      .attr("x2", d => d.target.x)
      .attr("y2", d => d.target.y);

  node
      .attr("transform", d => `translate(${d.x},${d.y})`);
});

function dragstarted(event, d) {
  if (!event.active) simulation.alphaTarget(0.3).restart();
  d.fx = d.x;
  d.fy = d.y;
}

function dragged(event, d) {
  d.fx = event.x;
  d.fy = event.y;
}

function dragended(event, d) {
  if (!event.active) simulation.alphaTarget(0);
  d.fx = null;
  d.fy = null;
}

function showTooltip(event, d) {
  tooltip.transition().duration(200).style("opacity", .9);
  tooltip.html(`<b>${d.id}</b><br/>${d.info}`)
         .style("left", (event.pageX + 10) + "px")
         .style("top", (event.pageY - 28) + "px");
}

function hideTooltip(event, d) {
  tooltip.transition().duration(500).style("opacity", 0);
}

</script>
</body>
</html>
